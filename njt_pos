#! /usr/bin/env ruby19

require 'chronic'
require 'json'
require './lib/snapshot.rb'

if ARGV.delete("--debug")
	NJTMap.log_level = NJTMap::Logger::INFO
end

if ARGV.delete("--profile")
	require 'profile'
	$stdout = File.new("/dev/null", "w", autoclose: true)
end

date =	if ARGV.length > 0
			date_str = ARGV[0]
			Chronic.parse(date_str)
		else
			Time.now
		end

snapshot = NJTMap::Snapshot.new(date)
puts ({locs: snapshot.positions.map { |pos|
		loc = pos.location_at_time(snapshot.seconds_into_day)
		{
			from: pos.first_stop.stop_name,
			to: pos.second_stop.stop_name,
			trip: pos.trip.trip_headsign,
			lat: loc.y,
			lon: loc.x,
			trip_id: pos.trip.trip_id,
		}
	}
}).to_json
